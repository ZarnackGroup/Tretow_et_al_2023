---
title: "Comparison of RTstop profiling results and in silico predictions"
author:
- name: Mario Keller
  affiliation: Faculty of Biological Sciences, Goethe University Frankfurt
output:
    BiocStyle::html_document:
      toc: TRUE
      toc_float: TRUE
      code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE,
                      crop=NULL, results = TRUE)
```

```{r libraries}
library(tidyverse)
library(knitr)
library(janitor)
library(Biostrings)
library(pqsfinder)
library(ggrepel)
library(ggrastr)
library(ggbeeswarm)
```

```{r defineTheme}
myTheme <- theme_bw() +
    theme(axis.text = element_text(size = 14, colour="black"),
          axis.title = element_text(size=16, colour="black"),
          axis.ticks=element_line(color="black"),
          axis.ticks.length=unit(.15, "cm"),
          panel.border=element_rect(color="black", fill = NA),
          panel.background = element_blank(),
          plot.background = element_blank(),
          legend.text = element_text(size=12),
          legend.position = "none")
```

```{r paths}
projectDir <- "/Users/jb/data/HNPRNPH/Tretow_et_al_2023"

dataDir <- paste0(projectDir, "/data")
RTstopDir <- paste0(projectDir, "/6_RTstop_profiling")
```

# Background

After classification of constructs as either rG4 or non-rG4 containing, it was
of interest to check to which extent the results are in agreement with in
silico predictions.

# Data

Construct classification and construct information (e.g. the nucleotide sequence)
are loaded from RDS-files.

```{r input}
constructClassification <- readRDS(paste0(dataDir,
                         "/RTstop_profiling/constructClassification.rds"))
constructClassification <- clean_names(constructClassification,
                                       case = "lower_camel")

constructInformation <- readRDS(paste0(dataDir,
                         "/RTstop_profiling/constructInformation.rds"))
constructInformation <- clean_names(constructInformation, case = "lower_camel")

# The nucleotide sequence is added to the construct classification data.frame
constructClassification <- left_join(constructClassification,
                                     constructInformation %>%
                                         dplyr::select(constructId, seq))

# Adjust category names
constructClassification <- constructClassification %>%
    mutate(regulationGroup = case_when(regulationGroup == "G4" ~ "rG4",
                                       TRUE ~ "non-rG4")) %>%
    mutate(regulationGroup = factor(regulationGroup,
                                    levels=c("rG4", "non-rG4")))

```

At first, the number of constructs identified as rG4 and non-rG4 containing is
plotted.

```{r}
constructClassification %>% dplyr::count(regulationGroup) %>%
    ggplot(., aes(x=regulationGroup, y=n)) +
    geom_col() +
    geom_text(aes(label = n), vjust = -0.5) +
    labs(x="Classification", y="Number of constructs") +
    myTheme +
    theme(aspect.ratio = 2/1)
```

# Prediction of rG4s 

To check the agreement of RTstop profiling results and the in silico predictions,
6 predictions with varying parameter setting are performed.

For this purpose, the sequences of the 2,169 constructs are turned into an
RNAStringSet.

```{r}
rss <- DNAStringSet(constructClassification$seq %>%
                        setNames(., constructClassification$constructId)) %>%
    RNAStringSet()
```



```{r}

if(!file.exists(paste0(RTstopDir,
                       "/RData/rG4predictions_2169_constructs.RData"))){
    
    parameterDf <- data.frame(
        max_len = c(30L, 40L, 30L, 40L, 45L, 45L),
        min_score = 25L,
        loop_min_len = 1L,
        loop_max_len = c(7L, 7L, 7L, 7L, 11L, 11L),
        max_defects = c(0L, 0L, 3L, 3L, 0L, 3L),
        note = c("Default setting of our study",
                 "rG4 length up to 40 nt",
                 "Up to 3 defects",
                 "rG4 up to 40 nt + up to 3 defects",
                 "Loop length up to 11 nt",
                 "Loop length up to 11 nt + up to 3 defects"),
        name = paste0("ParameterSet", 1:6)
    )
    
    pqrsfinderResults <- lapply(1:nrow(parameterDf), function(i){
    lapply(rss, function(rs){
        pqsfinder(rs,
                  strand="+", 
                  max_len = parameterDf$max_len[i],
                  min_score= parameterDf$min_score[i],
                  loop_min_len = parameterDf$loop_min_len[i],
                  loop_max_len = parameterDf$loop_max_len[i],
                  max_defects = parameterDf$max_defects[i]
                  )}
        )
        }) %>% setNames(., parameterDf$name)

save(parameterDf, pqrsfinderResults, file = paste0(RTstopDir,
                                                   "/RData/rG4predictions_2169_constructs.RData"))
    
} else {
    load(paste0(RTstopDir,
                "/RData/rG4predictions_2169_constructs.RData"))
}


```

Here is the table with the parameter settings:

```{r}
parameterDf %>%
    kable(., "html") %>%
    kableExtra::kable_styling("striped") %>%
    kableExtra::scroll_box(height="300px", width = "94%")
```

The agreement of the 6 prediction parameter settings with the RTstop profiling
results can be seen in the stacked barchart below. 

```{r }
plots <- lapply(1:nrow(parameterDf), function(i){
    res <- pqrsfinderResults[[i]]
    plotDf <- constructClassification %>% dplyr::select(constructId, regulationGroup)
    plotDf$predictedG4 <- res[plotDf$constructId] %>% lengths > 0
    
    
    p <- plotDf %>% dplyr::count(regulationGroup, predictedG4) %>%
        ggplot(., aes(x=regulationGroup, y=n, fill=predictedG4)) +
            geom_col(position="fill") +
            scale_fill_manual(values=c("TRUE" = "goldenrod3",
                                       "FALSE" = "grey")) +
            labs(x="RTstop profiling classification",
                 y="Fraction of constructs",
                 title="pqsfinder") +
            myTheme + theme(aspect.ratio=1/1,
                            axis.title = element_text(size=12, colour="black"),
                            axis.text = element_text(size = 12, colour="black")) 
    if(i == 2){
        p <- p +theme(legend.position = "bottom")
    }
    return(p)
})

egg::ggarrange(plots=plots, ncol=3, nrow=2)

csv <- read.csv("/Users/jb/data/HNPRNPH/additional analysis/RTstop_rG4_classification_with_G4mer_predictions.csv") %>% mutate(G4mer_label = as.logical(G4mer_label))

plots[[1]]

csv %>% dplyr::count(has_G4, G4mer_label) %>%
    ggplot(., aes(x=has_G4, y=n, fill=G4mer_label)) +
        geom_col(position="fill") +
        scale_fill_manual(values=c("TRUE" = "goldenrod3",
                                   "FALSE" = "grey")) +
        labs(x="RTstop profiling classification",
             y="Fraction of constructs",
             title="G4mer") +
        myTheme + theme(aspect.ratio=1/1,
                        axis.title = element_text(size=12, colour="black"),
                        axis.text = element_text(size = 12, colour="black")) 
```

We can see that slightly less than 75% of the rG4 constructs also have a
predicted rG4, while these are around 25% of the non-rG4 group using
our default parameter setting. When allowing for defects (bulges/mismatches),
the fraction of constructs with predicted rG4 strongly increases. However, the
fraction of non-rG4 constructs with a predicted rG4 also strongly increases.

# Disagreement of RTstop profiling and predictions

The results above raise the question why ~25% of non-rG4 constructs have a 
predicted rG4. One explanation could be that the G-stretches of the predicted
rG4s are trapped in other secondary structures / base-pairing with Cs. To check
this idea, the trimer content of rG4 and non-rG4 constructs with predicted rG4s
are compared.

At first, the two sets are extracted and in the next step the average frequency
of all trimers counted.

```{r}

constructClassification$predictedG4 <- pqrsfinderResults$ParameterSet1[constructClassification$constructId] %>% lengths > 0

# Create the two sets
rG4withPred <- constructClassification$constructId[constructClassification$regulationGroup == "rG4" & constructClassification$predictedG4]
non_rG4withPred <- constructClassification$constructId[constructClassification$regulationGroup == "non-rG4" & constructClassification$predictedG4]

# Create RNAStringSets
rG4withPred_rss <- rss[rG4withPred]
non_rG4withPred_rss <- rss[non_rG4withPred]

# Compute average trimer frequency
rG4withPred_trimers <- oligonucleotideFrequency(rG4withPred_rss, 3) %>% colMeans()
non_rG4withPred_trimers <- oligonucleotideFrequency(non_rG4withPred_rss, 3) %>% colMeans()
```

Trimer frequencies are plotted for the two sets and trimers with at least two
consecutive Gs or Cs highlighted.

```{r}

plotDf <- data.frame(trimer=names(rG4withPred_trimers),
           rG4withPred = rG4withPred_trimers,
           non_rG4withPred = non_rG4withPred_trimers)
plotDf$fill <- ""
plotDf$fill[grepl("GG", plotDf$trimer)] <- "GG"
plotDf$fill[grepl("CC", plotDf$trimer)] <- "CC"


p <- plotDf %>% arrange(fill) %>%
    mutate(trimer = ifelse(fill == "", "", trimer)) %>%
    ggplot(., aes(x=rG4withPred, y=non_rG4withPred, fill=fill)) +
        geom_point(shape=21, size=6) +
        geom_abline(slope=1, intercept=0) +
        scale_fill_manual(values=c("GG" = "#F49839",
                                   "CC" = "blue")) +
        geom_label_repel(mapping=aes(x=rG4withPred, y=non_rG4withPred, label=trimer), inherit.aes = FALSE, max.overlaps=Inf, min.segment.length=0, size=5.5) +
        coord_cartesian(xlim=c(0,10), ylim=c(0,10)) +
    labs(x="Mean trimer count for rG4 constructs with predicted rG4",
         y="Mean trimer count for non-rG4 constructs with predicted rG4") +
        myTheme +
        theme(aspect.ratio=1,
              axis.title = element_text(size=12, colour="black"),
                            axis.text = element_text(size = 12, colour="black"),
                            plot.title = element_text(size=8, colour="black"))


p

```

One can nicely see that rG4 constructs with predicted rG4 have a strong 
enrichment G-rich trimers (especially the trimer GGG). In contrast, the 
non-rG4 constructs with predicted rG4 hace a slight enrichment of C-rich
trimers (especially CCC). 

# Output

The constructClassification data.frame with the prediction information is
stored as RDS-File for further analysis in combination with the ivCLIP data.

```{r}
saveRDS(constructClassification, paste0(RTstopDir,
                                        "/rds_files/constructClassificationWithG4Prediction.rds"))
```

# Session Information

```{r}
sessionInfo()
```
